// ---------- Generators & Datasource ----------
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------- Enums ----------
enum Language {
  FR
  EN
  DE
}

enum VocabStatus {
  unknown
  green
  red
}

enum VocabReferenceKind {
  DEFAULT   // points to external JSON list `default_vocab` via reference_id
  CUSTOM    // points to CustomVocab via custom_vocab_id
}

// ---------- Models ----------
model User {
  id             Int       @id @default(autoincrement())
  uid            String    @unique       // Firebase UID
  email          String?
  emailVerified  Boolean   @default(false)
  createdAt      DateTime  @default(now())

  source_lang    Language  @default(EN)
  target_lang    Language  @default(FR)
  has_generated_default_lists Boolean @default(false)
  communicate_important_updates Boolean @default(true)

  // One-to-one favourite list pointer (unique makes it 1:1)
  favourite_list Int?      @unique
  favouriteList  VocabList?  @relation("FavouriteListRelation", fields: [favourite_list], references: [list_id])

  // All lists owned by the user (1:N)
  lists          VocabList[] @relation("OwnedListsRelation")

  customVocabs   CustomVocab[]
  hidden         HiddenVocab[]
  topicProgress  TopicProgress[]
  mockExams      MockExam[]
}

model CustomVocab {
  custom_vocab_id Int       @id @default(autoincrement())
  userId          Int      // Converted to required Int
  target_lang     Language
  source_lang     Language
  source_text     String
  target_text     String

  user  User   @relation(fields: [userId], references: [id])
  vocab Vocab[]

  @@index([userId])
}

model Vocab {
  vocab_id        Int                 @id @default(autoincrement())
  reference_id    Int?                // If DEFAULT: id (0..9999) from external JSON
  reference_kind  VocabReferenceKind
  custom_vocab_id Int?                // If CUSTOM: FK to CustomVocab
  
  customVocab CustomVocab?  @relation(fields: [custom_vocab_id], references: [custom_vocab_id])
  listItems   VocabListItem[]
  hiddenBy    HiddenVocab[]

  @@index([reference_kind, reference_id])
  @@index([custom_vocab_id])
}

model HiddenVocab {
  userId   Int      // Converted to required Int
  vocab_id Int

  user  User  @relation(fields: [userId], references: [id])
  vocab Vocab @relation(fields: [vocab_id], references: [vocab_id])

  @@id([userId, vocab_id])
}

model VocabList {
  list_id   Int      @id @default(autoincrement())
  userId    Int      // Converted to required Int
  list_name String

  // Owner side of 1:N (must share relation name with User.lists)
  user  User @relation("OwnedListsRelation", fields: [userId], references: [id])

  // Backfield for the 1:1 favourite list relation (singular)
  favouritedByUser User? @relation("FavouriteListRelation")

  items VocabListItem[]

  // A user cannot have two lists with the same name
  @@unique([userId, list_name])
  @@index([userId])
}

model VocabListItem {
  id           Int          @id @default(autoincrement())
  list_id      Int
  vocab_id     Int

  // Progress fields
  list_name    String?
  importance   Float        @default(0)
  timesGreen   Int          @default(0)
  timesRed     Int          @default(0)
  vocab_status VocabStatus  @default(unknown)

  listRef VocabList @relation(fields: [list_id], references: [list_id])
  vocab   Vocab     @relation(fields: [vocab_id], references: [vocab_id])

  @@unique([list_id, vocab_id])
  @@index([vocab_id])
}

// ---------- Progress Tracking ----------

enum TopicSection {
  DIALOGUE    // 0
  DISCUSSION  // 1
}

model TopicProgress {
  id        Int          @id @default(autoincrement())
  user_id   Int
  section   TopicSection
  topic_id  Int          // The ID of the scenario/discussion item

  user      User         @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, section, topic_id])
  @@index([user_id])
  @@map("topic_progress")
}

// ---------- Mock Exam System ----------

enum SectionType {
  A1
  A2
  B1
}

// Sections (JSON id storage)
model A1SectionSpeaking {
  id          Int      @id @default(autoincrement())
  json_id     String   @unique
  title       String
  language    Language @default(FR)
  
  answers     A1SectionSpeakingAnswer[]
  mockExams   MockExam[]
}

model A1SectionListening {
  id          Int      @id @default(autoincrement())
  json_id     String   @unique
  title       String
  language    Language @default(FR)
  
  answers     A1SectionListeningAnswer[]
  mockExams   MockExam[]
}

model A2SectionSpeaking {
  id          Int      @id @default(autoincrement())
  json_id     String   @unique
  title       String
  language    Language @default(FR)
  
  answers     A2SectionSpeakingAnswer[]
  mockExams   MockExam[]
}

model A2SectionListening {
  id          Int      @id @default(autoincrement())
  json_id     String   @unique
  title       String
  language    Language @default(FR)
  
  answers     A2SectionListeningAnswer[]
  mockExams   MockExam[]
}

model B1SectionSpeaking {
  id          Int      @id @default(autoincrement())
  json_id     String   @unique
  title       String
  language    Language @default(FR)
  
  answers           B1SectionSpeakingAnswer[]
  mockExamsOption1  MockExam[] @relation("B1SpeakingOption1")
  mockExamsOption2  MockExam[] @relation("B1SpeakingOption2")
  mockExamsSelected MockExam[] @relation("B1SpeakingSelected")
}

model B1SectionListening {
  id          Int      @id @default(autoincrement())
  json_id     String   @unique
  title       String
  language    Language @default(FR)
  
  answers           B1SectionListeningAnswer[]
  mockExams         MockExam[]
}

enum ExamPath {
  A1
  B1
}

// The Mock Exam Session
model MockExam {
  id          Int    @id @default(autoincrement())
  user_id     Int
  user        User   @relation(fields: [user_id], references: [id])
  
  // Explicitly track which path the user took
  selected_path ExamPath?

  // Track the attempt number for this exact exam combination
  attempt     Int    @default(1)

  // --- Speaking Components ---
  speaking_a2_id Int?
  speaking_a2    A2SectionSpeaking? @relation(fields: [speaking_a2_id], references: [id])
  
  speaking_a1_id Int?
  speaking_a1    A1SectionSpeaking? @relation(fields: [speaking_a1_id], references: [id])
  
  speaking_b1_option1_id Int?
  speaking_b1_option1    B1SectionSpeaking? @relation("B1SpeakingOption1", fields: [speaking_b1_option1_id], references: [id])
  
  speaking_b1_option2_id Int?
  speaking_b1_option2    B1SectionSpeaking? @relation("B1SpeakingOption2", fields: [speaking_b1_option2_id], references: [id])
  
  speaking_b1_id Int?
  speaking_b1    B1SectionSpeaking? @relation("B1SpeakingSelected", fields: [speaking_b1_id], references: [id])

  // --- Listening Components ---
  listening_a2_id Int?
  listening_a2    A2SectionListening? @relation(fields: [listening_a2_id], references: [id])
  
  listening_a1_id Int?
  listening_a1    A1SectionListening? @relation(fields: [listening_a1_id], references: [id])
  
  listening_b1_id Int?
  listening_b1    B1SectionListening? @relation(fields: [listening_b1_id], references: [id])

  // Answers Relations
  answersSpeakingA1     A1SectionSpeakingAnswer[]
  answersListeningA1 A1SectionListeningAnswer[]
  answersSpeakingA2     A2SectionSpeakingAnswer[]
  answersListeningA2 A2SectionListeningAnswer[]
  answersSpeakingB1     B1SectionSpeakingAnswer[]
  answersListeningB1 B1SectionListeningAnswer[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  status      String   @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED

  // Prevent duplicate speaking exams for the same user + A2 paper
  @@unique([user_id, speaking_a2_id])
}

// Section-Specific Answers
// When practicing standalone, mock_exam_id will be null.
model A1SectionSpeakingAnswer {
  id            Int         @id @default(autoincrement())
  user_id       Int
  mock_exam_id  Int?
  mock_attempt  Int?
  section_id    Int
  question_id   String

  mockExam      MockExam?   @relation(fields: [mock_exam_id], references: [id])
  section       A1SectionSpeaking  @relation(fields: [section_id], references: [id])

  answer_text   String?     @db.Text
  audio_url     String?     
  
  createdAt     DateTime    @default(now())

  @@index([section_id])
}

model A1SectionListeningAnswer {
  id            Int         @id @default(autoincrement())
  user_id       Int
  mock_exam_id  Int?
  mock_attempt  Int?
  section_id    Int
  question_id   String

  mockExam      MockExam?   @relation(fields: [mock_exam_id], references: [id])
  section       A1SectionListening  @relation(fields: [section_id], references: [id])

  answer_text   String?     @db.Text
  audio_url     String?     
  
  createdAt     DateTime    @default(now())

  @@index([section_id])
}

model A2SectionSpeakingAnswer {
  id            Int         @id @default(autoincrement())
  user_id       Int
  mock_exam_id  Int?
  mock_attempt  Int?
  section_id    Int
  question_id   String

  mockExam      MockExam?   @relation(fields: [mock_exam_id], references: [id])
  section       A2SectionSpeaking  @relation(fields: [section_id], references: [id])

  answer_text   String?     @db.Text
  audio_url     String?     
  
  createdAt     DateTime    @default(now())

  @@index([section_id])
}

model A2SectionListeningAnswer {
  id            Int         @id @default(autoincrement())
  user_id       Int
  mock_exam_id  Int?
  mock_attempt  Int?
  section_id    Int
  question_id   String

  mockExam      MockExam?   @relation(fields: [mock_exam_id], references: [id])
  section       A2SectionListening  @relation(fields: [section_id], references: [id])

  answer_text   String?     @db.Text
  audio_url     String?     
  
  createdAt     DateTime    @default(now())

  @@index([section_id])
}

model B1SectionSpeakingAnswer {
  id            Int         @id @default(autoincrement())
  user_id       Int
  mock_exam_id  Int?
  mock_attempt  Int?
  section_id    Int
  question_id   String

  mockExam      MockExam?   @relation(fields: [mock_exam_id], references: [id])
  section       B1SectionSpeaking  @relation(fields: [section_id], references: [id])

  answer_text   String?     @db.Text
  audio_url     String?     
  
  createdAt     DateTime    @default(now())

  @@index([section_id])
}

model B1SectionListeningAnswer {
  id            Int         @id @default(autoincrement())
  user_id       Int
  mock_exam_id  Int?
  mock_attempt  Int?
  section_id    Int
  question_id   String

  mockExam      MockExam?   @relation(fields: [mock_exam_id], references: [id])
  section       B1SectionListening  @relation(fields: [section_id], references: [id])

  answer_text   String?     @db.Text
  audio_url     String?     
  
  createdAt     DateTime    @default(now())

  @@index([section_id])
}